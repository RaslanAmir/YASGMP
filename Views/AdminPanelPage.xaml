<?xml version="1.0" encoding="utf-8" ?>
<!--
  File: YasGMP/Views/AdminPanelPage.xaml
  Purpose: Admin console with Users, RBAC, System, Tools — implemented using built-in MAUI TabbedPage
           to avoid third-party control resolution issues (fixes XFC0000 once and for all).
  Notes:
    - Shared header (title + actions) is included at the top of each tab for a consistent UX.
    - Tooltips replaced with SemanticProperties.Description to remain dependency-free and AOT-friendly.
-->
<TabbedPage
    x:Class="YasGMP.Views.AdminPanelPage"
    x:Name="AdminPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    Title="Admin">

  <TabbedPage.Resources>
    <Style TargetType="Button">
      <Setter Property="Margin" Value="4,2" />
      <Setter Property="Padding" Value="10,6" />
    </Style>
    <Style TargetType="Entry">
      <Setter Property="Margin" Value="4,2" />
    </Style>
    <Style TargetType="Label">
      <Setter Property="Margin" Value="2,0" />
    </Style>
    <Style TargetType="Frame">
      <Setter Property="CornerRadius" Value="12"/>
      <Setter Property="HasShadow" Value="True"/>
      <Setter Property="Padding" Value="12"/>
      <Setter Property="Margin" Value="0,8"/>
    </Style>
    <!-- Shared header as a ControlTemplate for reuse across tabs -->
    <ControlTemplate x:Key="AdminHeaderTemplate">
      <Grid RowDefinitions="Auto,Auto" RowSpacing="0">
        <!-- Header bar -->
        <Grid BackgroundColor="#F7F7F7" Padding="16,12" RowSpacing="0">
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
          </Grid.ColumnDefinitions>

          <VerticalStackLayout>
            <Label Text="YasGMP — Admin Console"
                   FontSize="22"
                   FontAttributes="Bold"
                   SemanticProperties.Description="Centralna administracija: korisnici, RBAC, sustav, alati" />
            <Label Text="{Binding HeaderSubtitle}"
                   FontSize="12"
                   TextColor="Gray" />
          </VerticalStackLayout>

          <HorizontalStackLayout Grid.Column="1" Spacing="8">
            <Button Text="Refresh"
                    Command="{Binding RefreshAllCommand}"
                    SemanticProperties.Description="Osvježi podatke i sistemske informacije" />
            <Button Text="Open Audit"
                    Command="{Binding OpenAuditCommand}"
                    SemanticProperties.Description="Otvori Audit / Events tab" />
          </HorizontalStackLayout>
        </Grid>

        <!-- Content host -->
        <ContentPresenter Grid.Row="1" />
      </Grid>
    </ControlTemplate>
  </TabbedPage.Resources>

  <!-- ===================== Users ===================== -->
  <ContentPage Title="Users" ControlTemplate="{StaticResource AdminHeaderTemplate}">
    <ScrollView>
      <VerticalStackLayout Padding="12" Spacing="8">

        <!-- Search + actions -->
        <Frame>
          <Grid ColumnDefinitions="2*,*,*,*,Auto" RowDefinitions="Auto">
            <Entry Grid.Column="0"
                   Placeholder="Filter by username / role"
                   Text="{Binding UserFilter, Mode=TwoWay}" />
            <Button Grid.Column="1" Text="Search" Command="{Binding LoadUsersCommand}" />
            <Button Grid.Column="2" Text="Lock"    Command="{Binding LockSelectedCommand}" IsEnabled="{Binding HasSelectedUser}" />
            <Button Grid.Column="3" Text="Unlock"  Command="{Binding UnlockSelectedCommand}" IsEnabled="{Binding HasSelectedUser}" />
            <Button Grid.Column="4" Text="Reload"  Command="{Binding LoadUsersCommand}" />
          </Grid>
        </Frame>

        <!-- Users grid -->
        <Frame>
          <Grid>
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto"/>
              <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- headers -->
            <Grid Grid.Row="0" ColumnDefinitions="60,*,120,80,100,Auto" Padding="6,0">
              <Label Text="ID" FontAttributes="Bold"/>
              <Label Grid.Column="1" Text="Username" FontAttributes="Bold"/>
              <Label Grid.Column="2" Text="Role" FontAttributes="Bold"/>
              <Label Grid.Column="3" Text="Active" FontAttributes="Bold"/>
              <Label Grid.Column="4" Text="Locked" FontAttributes="Bold"/>
              <Label Grid.Column="5" Text="Actions" FontAttributes="Bold"/>
            </Grid>

            <CollectionView Grid.Row="1"
                            ItemsSource="{Binding Users}"
                            SelectionMode="Single"
                            SelectedItem="{Binding SelectedUser, Mode=TwoWay}">
              <CollectionView.ItemTemplate>
                <DataTemplate>
                  <Grid Padding="6,2" ColumnDefinitions="60,*,120,80,100,Auto">
                    <Label Text="{Binding Id}" />
                    <Label Grid.Column="1" Text="{Binding Username}" />
                    <Label Grid.Column="2" Text="{Binding Role}" />
                    <Label Grid.Column="3" Text="{Binding Active}" />
                    <Label Grid.Column="4" Text="{Binding IsLocked}" />
                    <HorizontalStackLayout Grid.Column="5" Spacing="4">
                      <Button Text="Edit"
                              Command="{Binding Source={x:Reference AdminPage}, Path=BindingContext.EditUserCommand}"
                              CommandParameter="{Binding .}" />
                      <Button Text="Deactivate"
                              Command="{Binding Source={x:Reference AdminPage}, Path=BindingContext.DeactivateUserCommand}"
                              CommandParameter="{Binding .}" />
                      <Button Text="Delete"
                              Command="{Binding Source={x:Reference AdminPage}, Path=BindingContext.DeleteUserCommand}"
                              CommandParameter="{Binding .}" />
                    </HorizontalStackLayout>
                  </Grid>
                </DataTemplate>
              </CollectionView.ItemTemplate>
            </CollectionView>
          </Grid>
        </Frame>

        <!-- Create / Update -->
        <Frame>
          <VerticalStackLayout Spacing="6">
            <Label Text="Create / Update user"
                   FontAttributes="Bold" />
            <Grid ColumnDefinitions="*,*,*,Auto" RowDefinitions="Auto,Auto">
              <Entry Grid.Row="0" Grid.Column="0" Placeholder="Username"
                     Text="{Binding EditUsername}" />
              <Entry Grid.Row="0" Grid.Column="1" Placeholder="Role"
                     Text="{Binding EditRole}" />
              <Entry Grid.Row="0" Grid.Column="2" Placeholder="Password (new/initial)"
                     IsPassword="True" Text="{Binding EditPassword}" />
              <HorizontalStackLayout Grid.Row="0" Grid.Column="3" Spacing="6">
                <Button Text="Save"
                        Command="{Binding SaveUserCommand}" />
              </HorizontalStackLayout>

              <Grid Grid.Row="1" Grid.ColumnSpan="4" ColumnDefinitions="*,*,*,*,Auto">
                <Button Grid.Column="0" Text="Reset Password"
                        Command="{Binding ResetPasswordCommand}"
                        IsEnabled="{Binding HasSelectedUser}" />
                <Button Grid.Column="1" Text="Enable 2FA"
                        Command="{Binding Enable2FaCommand}"
                        IsEnabled="{Binding HasSelectedUser}" />
                <Button Grid.Column="2" Text="Disable 2FA"
                        Command="{Binding Disable2FaCommand}"
                        IsEnabled="{Binding HasSelectedUser}" />
                <Button Grid.Column="3" Text="Export Users"
                        Command="{Binding ExportUsersCommand}" />
              </Grid>
            </Grid>
          </VerticalStackLayout>
        </Frame>

      </VerticalStackLayout>
    </ScrollView>
  </ContentPage>

  <!-- ===================== RBAC ===================== -->
  <ContentPage Title="RBAC" ControlTemplate="{StaticResource AdminHeaderTemplate}">
    <ScrollView>
      <VerticalStackLayout Padding="12" Spacing="10">

        <!-- Selected user context -->
        <Frame>
          <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto">
            <Label Text="Selected user:" FontAttributes="Bold" />
            <Label Grid.Column="1" Text="{Binding SelectedUser.Username}" />
            <Label Grid.Row="1" Text="Role:" />
            <Label Grid.Row="1" Grid.Column="1" Text="{Binding SelectedUser.Role}" />
            <Label Grid.Row="2" Text="Active:" />
            <Label Grid.Row="2" Grid.Column="1" Text="{Binding SelectedUser.Active}" />
          </Grid>
        </Frame>

        <!-- ROLES: CRUD -->
        <Frame>
          <VerticalStackLayout Spacing="8">
            <Label Text="Roles" FontAttributes="Bold" />
            <Grid ColumnDefinitions="*,Auto,Auto,Auto" RowDefinitions="Auto,Auto,Auto">
              <!-- Search + actions -->
              <Entry Grid.Row="0" Grid.Column="0"
                     Placeholder="Filter roles (code/name)"
                     Text="{Binding RoleFilter, Mode=TwoWay}" />
              <Button Grid.Row="0" Grid.Column="1" Text="Reload"
                      Command="{Binding LoadRolesCommand}" />
              <Button Grid.Row="0" Grid.Column="2" Text="New"
                      Command="{Binding NewRoleCommand}" />
              <Button Grid.Row="0" Grid.Column="3" Text="Save"
                      Command="{Binding SaveRoleCommand}" />

              <!-- Roles list -->
              <CollectionView Grid.Row="1" Grid.ColumnSpan="4"
                              ItemsSource="{Binding Roles}"
                              SelectionMode="Single"
                              SelectedItem="{Binding SelectedRole, Mode=TwoWay}">
                <CollectionView.ItemTemplate>
                  <DataTemplate>
                    <Grid Padding="6,2" ColumnDefinitions="80,*,*,Auto">
                      <Label Text="{Binding Id}" />
                      <!-- UI 'Code' = Role.Name -->
                      <Label Grid.Column="1" Text="{Binding Name}" />
                      <Label Grid.Column="2" Text="{Binding Description}" />
                      <Button Grid.Column="3" Text="Delete"
                              Command="{Binding Source={x:Reference AdminPage}, Path=BindingContext.DeleteRoleCommand}"
                              CommandParameter="{Binding .}" />
                    </Grid>
                  </DataTemplate>
                </CollectionView.ItemTemplate>
              </CollectionView>

              <!-- Role editor -->
              <Grid Grid.Row="2" Grid.ColumnSpan="4" ColumnDefinitions="*,*,2*,Auto">
                <Entry Grid.Column="0" Placeholder="Code"
                       Text="{Binding EditRoleCode}" />
                <Entry Grid.Column="1" Placeholder="Name"
                       Text="{Binding EditRoleName}" />
                <Entry Grid.Column="2" Placeholder="Description"
                       Text="{Binding EditRoleDescription}" />
                <Button Grid.Column="3" Text="Save"
                        Command="{Binding SaveRoleCommand}" />
              </Grid>
            </Grid>
          </VerticalStackLayout>
        </Frame>

        <!-- ROLE ↔ PERMISSIONS -->
        <Frame>
          <VerticalStackLayout Spacing="8">
            <Label Text="Role Permissions" FontAttributes="Bold" />
            <Grid ColumnDefinitions="*,Auto,*" RowDefinitions="Auto,Auto,*">
              <Label Grid.Row="0" Grid.Column="0" Text="Available permissions" />
              <Label Grid.Row="0" Grid.Column="2" Text="Assigned to selected role" />

              <Grid Grid.Row="1" Grid.Column="0" ColumnDefinitions="*,Auto">
                <Entry Placeholder="Filter available"
                       Text="{Binding PermissionFilter, Mode=TwoWay}" />
              </Grid>

              <CollectionView Grid.Row="2" Grid.Column="0"
                              ItemsSource="{Binding AvailablePermissions}"
                              SelectionMode="Single"
                              SelectedItem="{Binding SelectedAvailablePermission, Mode=TwoWay}">
                <CollectionView.ItemTemplate>
                  <DataTemplate>
                    <Grid Padding="6,2" ColumnDefinitions="160,*,Auto">
                      <Label Text="{Binding Code}" />
                      <Label Grid.Column="1" Text="{Binding Name}" />
                    </Grid>
                  </DataTemplate>
                </CollectionView.ItemTemplate>
              </CollectionView>

              <VerticalStackLayout Grid.Row="2" Grid.Column="1" VerticalOptions="Center" Spacing="6">
                <Button Text=">>"
                        Command="{Binding AddPermissionToRoleCommand}"
                        CommandParameter="{Binding SelectedAvailablePermission}" />
                <Button Text="&lt;&lt;"
                        Command="{Binding RemovePermissionFromRoleCommand}"
                        CommandParameter="{Binding SelectedRolePermission}" />
              </VerticalStackLayout>

              <CollectionView Grid.Row="2" Grid.Column="2"
                              ItemsSource="{Binding RolePermissions}"
                              SelectionMode="Single"
                              SelectedItem="{Binding SelectedRolePermission, Mode=TwoWay}">
                <CollectionView.ItemTemplate>
                  <DataTemplate>
                    <Grid Padding="6,2" ColumnDefinitions="160,*,Auto">
                      <Label Text="{Binding Code}" />
                      <Label Grid.Column="1" Text="{Binding Name}" />
                    </Grid>
                  </DataTemplate>
                </CollectionView.ItemTemplate>
              </CollectionView>
            </Grid>
          </VerticalStackLayout>
        </Frame>

        <!-- USER ↔ ROLES -->
        <Frame>
          <VerticalStackLayout Spacing="8">
            <Label Text="User ↔ Roles" FontAttributes="Bold" />
            <Grid ColumnDefinitions="*,Auto,*" RowDefinitions="Auto,*">
              <Label Grid.Row="0" Grid.Column="0" Text="Available roles" />
              <Label Grid.Row="0" Grid.Column="2" Text="Assigned to selected user" />

              <CollectionView Grid.Row="1" Grid.Column="0"
                              ItemsSource="{Binding AvailableRolesForUser}"
                              SelectionMode="Single"
                              SelectedItem="{Binding SelectedAvailableRoleForUser, Mode=TwoWay}">
                <CollectionView.ItemTemplate>
                  <DataTemplate>
                    <Grid Padding="6,2" ColumnDefinitions="160,*,Auto">
                      <!-- UI 'Code' = Role.Name -->
                      <Label Text="{Binding Name}" />
                      <Label Grid.Column="1" Text="{Binding Description}" />
                    </Grid>
                  </DataTemplate>
                </CollectionView.ItemTemplate>
              </CollectionView>

              <VerticalStackLayout Grid.Row="1" Grid.Column="1" VerticalOptions="Center" Spacing="6">
                <Button Text="Assign"
                        Command="{Binding AssignRoleToUserCommand}"
                        CommandParameter="{Binding SelectedAvailableRoleForUser}" />
                <Button Text="Remove"
                        Command="{Binding RemoveRoleFromUserCommand}"
                        CommandParameter="{Binding SelectedAssignedRoleForUser}" />
              </VerticalStackLayout>

              <CollectionView Grid.Row="1" Grid.Column="2"
                              ItemsSource="{Binding AssignedRolesForUser}"
                              SelectionMode="Single"
                              SelectedItem="{Binding SelectedAssignedRoleForUser, Mode=TwoWay}">
                <CollectionView.ItemTemplate>
                  <DataTemplate>
                    <Grid Padding="6,2" ColumnDefinitions="160,*,Auto">
                      <!-- UI 'Code' = Role.Name -->
                      <Label Text="{Binding Name}" />
                      <Label Grid.Column="1" Text="{Binding Description}" />
                    </Grid>
                  </DataTemplate>
                </CollectionView.ItemTemplate>
              </CollectionView>
            </Grid>
          </VerticalStackLayout>
        </Frame>

      </VerticalStackLayout>
    </ScrollView>
  </ContentPage>

  <!-- ===================== System ===================== -->
  <ContentPage Title="System" ControlTemplate="{StaticResource AdminHeaderTemplate}">
    <ScrollView>
      <VerticalStackLayout Padding="12" Spacing="8">
        <Frame>
          <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto">
            <Label Text="App Version:" />
            <Label Grid.Column="1" Text="{Binding AppVersion}" />
            <Label Grid.Row="1" Text="OS:" />
            <Label Grid.Row="1" Grid.Column="1" Text="{Binding OsVersion}" />
            <Label Grid.Row="2" Text="Host:" />
            <Label Grid.Row="2" Grid.Column="1" Text="{Binding HostName}" />
            <Label Grid.Row="3" Text="User:" />
            <Label Grid.Row="3" Grid.Column="1" Text="{Binding UserName}" />
            <Label Grid.Row="4" Text="Local IP:" />
            <Label Grid.Row="4" Grid.Column="1" Text="{Binding LocalIp}" />
          </Grid>
        </Frame>

        <Frame>
          <VerticalStackLayout>
            <Label Text="Diagnostic / Health Checks" FontAttributes="Bold"/>
            <HorizontalStackLayout>
              <Button Text="Test DB" Command="{Binding TestDbCommand}" />
              <Label Text="{Binding DbTestResult}" VerticalTextAlignment="Center" />
            </HorizontalStackLayout>
          </VerticalStackLayout>
        </Frame>
      </VerticalStackLayout>
    </ScrollView>
  </ContentPage>

  <!-- ===================== Tools ===================== -->
  <ContentPage Title="Tools" ControlTemplate="{StaticResource AdminHeaderTemplate}">
    <ScrollView>
      <VerticalStackLayout Padding="12" Spacing="8">
        <Frame>
          <VerticalStackLayout>
            <Label Text="Quick actions" FontAttributes="Bold"/>
            <HorizontalStackLayout>
              <Button Text="Force Audit Snapshot"
                      Command="{Binding ForceAuditSnapshotCommand}" />
              <Button Text="Record System Note"
                      Command="{Binding RecordSystemNoteCommand}" />
            </HorizontalStackLayout>
          </VerticalStackLayout>
        </Frame>
      </VerticalStackLayout>
    </ScrollView>
  </ContentPage>

</TabbedPage>
