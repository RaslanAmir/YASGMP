# Codex Plan — WPF Shell & Full Integration

## Current Compile Status
- [ ] Dotnet SDKs detected and recorded *(blocked: `dotnet` CLI not available in container PATH`; `dotnet --info` retried 2025-09-24, 2025-09-25, 2025-09-26, 2025-09-27, 2025-09-28, 2025-09-29, 2025-10-14, 2025-10-17, 2025-10-23, 2025-10-24, 2025-10-30, 2025-11-01, 2025-11-04, 2025-11-07, 2025-11-09, and 2025-11-18, 2025-11-19, 2025-11-30, 2025-12-04, 2025-12-08 → **command not found**)*
- [ ] Solution restores *(pending SDK availability; `dotnet restore` retried 2025-09-24, 2025-09-25, 2025-09-26, 2025-09-27, 2025-09-29, 2025-10-14, 2025-10-17, 2025-10-23, 2025-10-24, 2025-10-30, 2025-11-01, 2025-11-02, 2025-11-04, 2025-11-07, 2025-11-09, and 2025-11-18, 2025-11-19, 2025-11-30, 2025-12-04, 2025-12-08 → **command not found**)*
- [ ] MAUI builds *(pending SDK availability; `dotnet build` retried 2025-09-25, 2025-09-26, 2025-09-27, 2025-09-29, 2025-10-14, 2025-10-17, 2025-10-23, 2025-10-24, 2025-10-30, 2025-11-01, 2025-11-02, 2025-11-04, 2025-11-07, 2025-11-09, and 2025-11-18, 2025-11-19, 2025-11-30, 2025-12-04, 2025-12-08 → **command not found**)*
- [ ] WPF builds *(pending SDK availability; `dotnet build` retried 2025-09-25, 2025-09-26, 2025-09-27, 2025-09-29, 2025-10-14, 2025-10-17, 2025-10-23, 2025-10-24, 2025-10-30, 2025-11-01, 2025-11-02, 2025-11-04, 2025-11-07, 2025-11-09, and 2025-11-18, 2025-11-19, 2025-11-30, 2025-12-04, 2025-12-08 → **command not found**)*

## Decisions & Pins
- Preferred WPF target: **net9.0-windows10.0.19041.0** (retain once .NET 9 SDK is installed).
- Repo-level SDK pin: `global.json` set to **9.0.100** *(reinforced via bootstrap script).* 
- AvalonDock: **4.72.1** *(pinned in `YasGMP.Wpf.csproj`).*
- Other NuGets: **Fluent.Ribbon 11.0.1**, **CommunityToolkit.Mvvm 8.4.0**, **Microsoft.Extensions.* 9.0.3**, **MySqlConnector 2.4.0** *(pinned in csproj).* 
- Environment gap: install/enable **.NET 9 SDK** and **Windows 10 SDK (19041+)** on the host. The build container currently lacks `dotnet`; run `scripts/bootstrap-dotnet9.ps1` or install via `winget install Microsoft.DotNet.SDK.9`.

## Batches
- **B0 — Environment stabilization** (SDKs, NuGets, XAML namespaces) — **blocked** *(no `dotnet` CLI)*
- **B1 — Shell foundation** (Ribbon, Docking, StatusBar, FormMode state machine) — [ ] todo
- **B2 — Cross-cutting** (Attachments DB, E-Signature, Audit) — [~] in-progress *(e-sign capture now spans Assets, Components, Warehouses, Incidents, CAPA, Change Control, Validations, Scheduled Jobs, Suppliers, External Servicers, Users, and Work Orders; WPF adapters and AppCore services propagate optional signature metadata through to the database, falling back to the legacy hash generator only when metadata is missing; the WPF dialog service now emits audit events on capture/persist while broader audit surfacing remains gated on SDK access)*
- **B3 — Editor framework** (templates, host, unsaved-guard) — [ ] todo
- **B4+ — Module rollout:**
  - Assets/Machines — [x] done *(mode-aware CRUD with attachment uploads and e-signature capture via IElectronicSignatureDialogService; audit surfacing still pending)*
  - Components — [x] done *(mode-aware editor wired to ComponentService with IElectronicSignatureDialogService gating persistence; audit surfacing remains blocked on SDK access)*
  - Parts & Warehouses — [x] done *(inventory snapshots, warehouse ledger preview, stock health warnings, and e-signature capture baked into save flows; audit surfacing remains blocked on SDK access)*
  - Work Orders — [x] done *(CRUD adapter wired with attachments and e-signature capture ahead of adapter calls; audit surfacing queued once SDK access returns)*
  - Calibration — [x] done *(CRUD editor with attachment uploads and e-signature capture; audit surfacing remains queued for Batch B2)*
  - Incident → CAPA → Change Control — [x] done *(Incidents, CAPA, and Change Control editors now CRUD-capable with attachments and signature capture; audit surfacing still queued for SDK access)*
  - Validations (IQ/OQ/PQ) — [x] done *(mode-aware validation editor with CRUD adapter, CFL, attachment workflow, and signature capture; audit surfacing queued once the SDK blocker clears)*
  - Scheduled Jobs — [x] done *(mode-aware editor with execute/acknowledge tooling, attachment workflow, and enforced signature capture; audit surfacing tracked under Batch B2)*
  - Users/Roles — [x] done *(Security module now exposes a CRUD-capable user/role editor with CFL, toolbar modes, role assignment management, and e-signature gating)*
  - Suppliers/External Servicers — [x] done *(Suppliers module enforces electronic signatures on save alongside attachments + CFL; External Servicers cockpit now also blocks persistence on signature capture)*
  - Audit/API Audit — [~] in-progress *(WPF audit trail now pulls filtered entries via AuditService with expanded inspector grid, filters, and explicit empty/error status flags.)*
  - Documents/Attachments — [ ] todo
  - Dashboard/Reports — [ ] todo
  - Settings/Admin — [ ] todo

- **Open Issues / Blockers**
- `dotnet` executable not found. Install/expose **.NET 9 SDK** and **Windows 10 SDK (19041+)** on the host; if building inside a container, expose host `dotnet` or install within the container. Run `scripts/bootstrap-dotnet9.ps1` to verify and pin via `global.json`. *(2025-09-25 & 2025-09-27 retries confirmed `dotnet --info` continues to fail with **command not found**; 2025-10-09 recheck still reports the command missing.)*
  - Pending inventory of MAUI assets/services/modules; schedule once SDK issue is resolved.
  - Smoke automation is blocked until SDK + Windows tooling are installed.
- Audit inspector surfacing and smoke automation remain blocked until the SDK gap is resolved.
  - 2025-09-24: Batch 0 rerun inside container confirmed `.NET 9` CLI is still missing; all `dotnet` commands fail immediately. Remains a prerequisite before module CRUD refactors can progress.

## Notes
- 2025-12-05: Added WPF unit coverage exercising ValidationCrudServiceAdapter context propagation, updated the validation CRUD
  fake to retain signature/IP/session metadata, and asserted CrudSaveResult mirrors the persisted entity so regressions surface
  quickly while dotnet CLI access remains blocked.
- 2025-12-07: External Servicer CRUD fake now records saved snapshots alongside contexts, cleans up deleted entries, and confirms CrudSaveResult metadata still flows from the provided context; attempted dotnet restore/build/smoke remain blocked because the CLI is still missing in the container.
- 2025-12-08: Test signature dialog now tracks captured results/persist invocations, CRUD fakes accept configurable signature-id providers to mirror adapter-assigned identifiers, and module regression tests assert returned ids skip redundant persistence while the dotnet CLI remains unavailable.
- 2025-12-06: Security persistence now writes `digital_signature`/`last_change_signature` along with IP/device/session metadata via DatabaseService.Users extensions, and new UserCrudServiceAdapter tests assert the context and signatures persist end-to-end while the dotnet CLI gap continues to block restore/build.
- 2025-12-04: Validation persistence now writes `source_ip`/`session_id` on insert/update and ValidationService unit tests assert the metadata survives adapter calls; dotnet CLI still missing so restore/build/test remain blocked.
- 2025-12-01: Change Control schema/service now persist digital signature hash plus IP/session/device context so adapter metadata flows through unchanged; database scripts updated accordingly while CLI validation remains blocked.
- 2025-12-03: ValidationService now preserves adapter-provided digital signature hashes on create/update paths, only regenerating during forced transitions (e.g., Execute); unit coverage added to confirm the adapter hash survives persistence while dotnet CLI access remains blocked.
- 2025-12-02: ComponentService now accepts a ComponentSaveContext so WPF adapters can persist signature hash/IP/device/session without regeneration; machine_components INSERT/UPDATE now write digital_signature/source_ip/device/session columns and unit coverage asserts the stored hash matches the adapter payload while dotnet CLI validation remains blocked.
- 2025-12-01: dotnet restore/build and WPF smoke harness still blocked by missing dotnet CLI; rerun once host installs .NET 9/Windows SDK.
- 2025-11-30: Assets save flow now applies CrudSaveResult digital signature ids immediately after persistence and removes the stale OnRecordSelected signature block; build validation remains blocked pending dotnet CLI access.
- 2025-11-13: Completed signature metadata DTO propagation through Machine, Work Order, Calibration, Supplier, and Part services plus DatabaseService helpers; persistence now accepts optional metadata and falls back to the legacy hash generator when absent, while WPF adapters feed DTOs downstream.
- 2025-11-14: Database helpers for machines, work orders, calibrations, suppliers, and parts now persist digital_signature_id columns when present, tolerate legacy schemas, and upsert the digital_signatures table with hash/method/status/note metadata while propagating the resulting signature id back to DTOs and audit flows.
- 2025-11-15: Read-side queries for calibrations, work orders, and parts now prefer the digital_signature_id column with legacy fallbacks so editors and audit trails can reuse persisted signature references regardless of schema vintage.
- 2025-11-16: CAPA service/interface now accept optional `SignatureMetadataDto` arguments propagated from the WPF adapter; DatabaseService.Capa helpers persist the metadata into `digital_signatures` while preserving legacy overloads, and `dotnet restore/build` attempts still fail because the CLI is absent inside the container (`command not found`).
- 2025-11-17: System event logging now records digital signature ids/hashes alongside audit payloads with automatic fallbacks for legacy schemas; unit coverage verifies both the enriched insert and the legacy downgrade path.
- 2025-11-18: Test electronic signature dialog service now assigns incremental signature ids, clones persisted results, and records hash/method/status/note metadata for assertions while dotnet CLI access remains blocked.
- 2025-11-19: WPF test CRUD fakes now capture create/update snapshots with contexts to simplify module assertions; dotnet restore/build retries still fail because the CLI is absent in the container.
- 2025-11-20: WPF module regression tests now pin signature dialog ids, assert CRUD contexts surface signature hash/method/status/note metadata, and confirm persisted signature ids are returned from the enhanced dialog service while dotnet CLI access remains unavailable.
- 2025-11-28: Added a shared `CrudSaveResult` payload so adapters can return the persisted identifier together with captured signature metadata, keeping downstream editors and audit logging aligned once save operations complete.
- 2025-11-29: WPF CRUD interfaces, adapters, and module view-models now consume the new `CrudSaveResult` record end-to-end, storing returned identifiers, refreshing editor state, and surfacing signature metadata; WPF test doubles and regression tests assert the result payload.
- `scripts/bootstrap-dotnet9.ps1` added to guide host setup *(installs/verifies .NET 9, Windows SDK, runs restore/build, seeds smoke test fixture).* 
- `YasGMP.Wpf` already targets .NET 9 and references pinned packages; validate once builds are possible.
- `tests/fixtures/hello.txt` seeded for upcoming smoke harness scenarios.
- 2025-10-30: Introduced `AttachmentWorkflowService` in the WPF shell so module view-models share MAUI's dedup/encryption/retention workflow via `AttachmentService` + `DatabaseService.Attachments` helpers; registration and commands now rely on the adapter.
- 2025-11-01: Assets, Work Orders, Calibration, Suppliers, and Parts now block saves on successful electronic signature capture, persist the resulting digital signature hash, and surface cancellation/failure states through StatusMessage; unit tests gained a reusable signature dialog stub.
- 2025-11-02: Test project relocated the electronic signature dialog fake into `TestDoubles`, added queueable results/exception hooks, and updated module/unit factories to inject the dependency explicitly.
- 2025-11-03: Extended IElectronicSignatureDialogService integration across Components, Warehouses, Incidents, Validations, CAPA, Change Control, External Servicers, Scheduling, and Security modules with metadata propagation and refreshed unit coverage.
- 2025-11-04: Assets (machines) save flow now enriches the persisted machine with last-modified metadata after signature capture to keep downstream persistence aligned with Issue 3 requirements.
- 2025-11-05: Electronic signature dialog service now separates capture from persistence, allowing modules to update generated record ids, persist the business entity first, and retry signature storage with clear status messaging when failures occur.
- 2025-11-06: Assets editor now surfaces full e-sign metadata (hash, signer, reason, session/IP) via the new SignatureAwareEditor base and SignatureMetadataView control; save flow stamps the metadata before persistence while SDK access remains blocked.
- 2025-11-07: Added `B1FormDocumentViewModel` regression coverage to ensure cancellation status text, dirty tracking, and form mode remain intact when `OnSaveAsync` returns false; SDK/tooling still blocked by missing `dotnet` CLI.
- 2025-11-08: Introduced `TestElectronicSignatureDialogService` with queueable confirmations/cancellations/exceptions and updated module/unit factories to consume the new helper while keeping the legacy fake as an alias.
- 2025-11-09: Updated WPF module unit tests to inject `TestElectronicSignatureDialogService` in the new constructor slot after attachment workflow services; dotnet CLI still unavailable so test runs remain blocked.
- 2025-11-10: Added WPF module regression tests covering electronic signature cancellation/exception flows to ensure edit mode persists and adapters are not invoked when capture fails; dotnet CLI remains unavailable so restore/build/test steps are still blocked.
- 2025-11-21: Calibration module unit tests now queue cancellation/exception paths on the signature dialog to assert saves abort before persistence and no signature metadata is stored when capture fails.
- 2025-11-22: Suppliers module unit tests now cover electronic signature cancellation and capture exception flows to ensure form mode/status remain stable and no supplier/signature data persists when capture fails; dotnet CLI access is still pending for restore/build validation.
- 2025-11-23: Attachment workflow now injects AuditService to stamp upload metadata (actor/entity/dedup/reason/timestamp) and unit coverage verifies the audit hook fires for both new and deduplicated uploads; dotnet CLI remains unavailable so restore/build/test attempts still fail with `command not found`.
- 2025-11-24: ElectronicSignatureDialogService now resolves AuditService, logging capture and persistence events with reason metadata; WPF dialog service tests assert both audit emissions alongside digital signature persistence while the dotnet CLI gap persists.
- 2025-11-25: DataDrivenModuleDocumentViewModel now accepts an optional AuditService hook so every module can share audit helpers, and Work Orders save flow records CREATE/UPDATE audit events with signature/user/IP/device/session metadata after successful persistence; WPF module tests now inject AuditService accordingly while dotnet CLI access remains unavailable.
- 2025-11-26: Introduced a RecordingAuditService test double for the WPF harness so Work Orders unit tests assert CREATE saves stamp signer context and attachment uploads emit audit hooks; restore/build attempts remain blocked by the missing dotnet CLI.
- 2025-11-27: All module save flows now rehydrate adapter-updated signature ids/hashes/method/status metadata before invoking the dialog service, skipping redundant persistence when the signature already exists while keeping the existing success messaging unchanged.
- 2025-10-31: WPF shell now exposes an `IElectronicSignatureDialogService` that drives the signature dialog, captures password/PIN plus GMP reason text, and persists the note via the shared DatabaseService extensions before closing.
- Assets module now exposes an attachment command that uploads via `IAttachmentService`; coverage added in unit tests.
- Components module now completes the CRUD rollout with mode-aware editor, validation, machine lookups, and electronic signature capture ahead of persistence.
- Parts and Warehouse modules now expose CRUD-capable editors with attachment upload support, stock-health warnings, warehouse inventory previews, and enforced e-signature capture; audit surfacing remains tied to Batch B2 once SDK access is restored.
- 2025-09-29: WPF mapping updated to reflect the Components document and adapter usage; attachment/e-signature work still planned for Batch B2 once SDK access restored.
  - Work Orders module now drives CRUD through `IWorkOrderCrudService` with attachment uploads; e-signature/audit pane pending B2.
- Calibration module now reuses `CalibrationService` through a new adapter with mode-aware editor, supplier/component lookups, and attachment uploads via `IAttachmentService`; signature/audit follow-ups remain planned under Batch B2.
- Validations module now mirrors the MAUI experience with a CRUD-capable editor backed by `ValidationService`, machine/component lookups, CFL support, attachment uploads, and signature capture; audit surfacing targeted for Batch B2 once the SDK blocker clears.
- Scheduling module now ships with a CRUD-capable editor backed by the new `IScheduledJobCrudService`, attachment uploads, execute/acknowledge commands, and signature gating; audit prompts remain planned for Batch B2.
- 2025-10-06: Users/Roles (Security) module now reuses the shared user/RBAC services through a new adapter, exposing a mode-aware editor with CFL, role assignments, unit coverage, and e-signature enforcement; audit surfacing remains queued for Batch B2.
- 2025-10-07: Suppliers module now leverages ISupplierCrudService with a mode-aware editor, attachments via AttachmentService, CFL/golden-arrow integration, and unit coverage; External Servicers now share the same signature enforcement path.
- 2025-10-08: External Servicers module now mirrors MAUI CRUD with a dedicated adapter, WPF view, CFL picker, golden-arrow navigation, and unit/smoke coverage updates.
- 2025-10-09: External Servicer service now delegates CRUD to `DatabaseServiceExternalServicersExtensions`; regression tests assert create/update/delete hit `external_contractors`. Restore/build remain blocked until the .NET CLI is available in the container.
- 2025-10-10: Audit module now surfaces AuditService-backed filtering (user/entity/action/date) with richer inspector columns and WPF unit coverage; `dotnet --info` still reports `command not found` inside the container.
- 2025-10-11: B1 form base now exposes FormatLoadedStatus, letting the Audit module emit entry-specific status text without collection hooks; tests cover singular/plural/no-result messages.
- 2025-10-12: Audit module filters now normalize date ranges to inclusive day boundaries and backfill empty end dates so AuditService always receives valid bounds; unit tests cover the end-of-day behavior.
- 2025-10-13: WPF host now keeps a single AuditService singleton registration aligned with MAUI; attempted `dotnet restore`/`dotnet build` still fail because the CLI is unavailable in the container.
- 2025-10-15: Audit filters now clamp the start date to midnight, expand the end date to the day's final tick, and auto-swap reversed ranges; WPF coverage verifies date-only `FilterTo` inputs reach the end-of-day timestamp.
- 2025-10-16: B1 refresh path now pushes counts through `FormatLoadedStatus`, letting Audit override emit zero/singular/plural status text; tests assert the audit-specific messaging via `RefreshAsync`.
- 2025-10-17: Audit filters now treat null DatePicker inputs as optional bounds, default the end date to the selected start day, and extend it to the day's final tick; WPF unit coverage verifies `LastToFilter` captures the end-of-day timestamp for calendar-only inputs.
- 2025-10-18: Centralised the WPF host's `AuditService` registration through a guard helper so only the singleton remains; added DI coverage ensuring duplicate registrations are removed before building the provider.
- 2025-10-19: B1 refresh status now pulls from the applied record count so overrides reflect the actual dataset after filtering; audit module retains zero/singular/plural messaging via `FormatLoadedStatus`.
- 2025-10-20: Audit filters now centralize range normalization so date pickers can be left empty, clamp the start day to midnight, and expand the end day to its final tick; coverage asserts a date-only upper bound reaches the service as an end-of-day timestamp.
- 2025-10-21: Confirmed the WPF host retains a singleton AuditService registration and added DI coverage ensuring AuditModuleViewModel resolves after the cleanup.
- 2025-10-22: Hardened B1 status formatting to clamp negative counts and kept the Audit override routing zero-or-less results to the empty audit message; unit tests continue to assert the singular/plural/no-result wording via RefreshAsync.
- 2025-10-23: Audit filters now normalize nullable DatePicker inputs with unspecified kinds, persisting sanitized start/end dates in the view-model while expanding the service-bound end date to the day's final tick; `dotnet --info`/restore/build attempts still fail because the CLI remains unavailable in the container.
- 2025-10-24: WPF host now registers `AuditService` directly as a singleton (removing the stray transient), and DI coverage confirms `AuditModuleViewModel` resolves with the singleton; `dotnet restore`/`dotnet build` retries continue to fail with **command not found** until the SDK is installed.
- 2025-10-25: Audit module now surfaces HasResults/HasError flags, highlights offline/error status text in the view, and relabels the inspector reason column; `dotnet` CLI is still unavailable so restore/build attempts continue to fail.
- 2025-10-26: Audit filters now preserve the user-selected end date even when it predates the start picker, clamping the query's start bound to the chosen end day and covering the regression with WPF tests.
- 2025-10-27: Audit filters now clamp the lower bound when the upper bound is moved earlier while preserving the user's selected end day; WPF regression coverage verifies both persisted filters and query arguments.
- 2025-10-28: Audit filters now keep the user's "To" picker intact while ordering the query bounds when the upper date precedes the lower; WPF coverage adds a default-from regression asserting the service respects the earlier upper bound.
- 2025-10-29: Audit filters now order query bounds by min/max so inverted ranges still span the full window while preserving the user's "To" picker; WPF regression coverage asserts the service receives the later bound's end-of-day timestamp.
- 2025-11-11: CRUD context factories now expose signature id/hash/method/status/note members with an overload that accepts `ElectronicSignatureDialogResult`, letting module save flows hydrate audit metadata alongside user/IP/session defaults.
- 2025-11-12: Machine, Work Order, Calibration, Supplier, and Part adapters now hydrate captured signature hash/method/status/note onto their entities before persistence and include the metadata in supplier/part audit stamps while core services await extended signatures support.
- Next actionable slice once SDK access is restored: wire Assets attachments + signatures, then replicate CRUD pattern for Components.
- 2025-09-26: Assets editor now drives MachineService CRUD + validation with mode-aware UI; run smoke harness once SDK restored.
- 2025-09-27: Components module now surfaces a CRUD-capable editor using ComponentService with machine lookups; attachments/e-signature integration tracked under Batch B2.
- 2025-09-30: Incidents module now drives CRUD via `IIncidentCrudService`, exposes a full editor with toolbar modes, and supports attachment uploads; CAPA/Change Control modules remain queued.
- 2025-10-01: Incidents editor adds CFL linking for work orders/CAPA cases with tests covering the new mode transitions.
- 2025-10-02: CAPA module now runs through ICapaCrudService with mode-aware editor, component lookups, and attachment uploads; signature/audit follow-ups remain planned under Batch B2.
- 2025-10-03: Change Control module now reuses the new `IChangeControlCrudService` adapter with a mode-aware editor, CFL picker, and attachment workflow; e-signature/audit surfacing will arrive with Batch B2 once the SDK blocker lifts.
